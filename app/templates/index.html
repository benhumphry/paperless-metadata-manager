{% extends "base.html" %} {% block content %}
<div x-data="metadataManager()" x-init="init()">
    <!-- Metadata Type Selector -->
    <div class="mb-6 bg-white shadow rounded-lg p-4">
        <label class="block text-sm font-medium text-gray-700 mb-2"
            >Metadata Type</label
        >
        <select
            x-model="metadataType"
            @change="onMetadataTypeChange()"
            class="w-full max-w-xs px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500"
        >
            <option value="tags">Tags</option>
            <option value="correspondents">Correspondents</option>
            <option value="document_types">Document Types</option>
        </select>
    </div>

    <!-- Tabs -->
    <div class="mb-6 border-b border-gray-200">
        <nav class="-mb-px flex space-x-8">
            <button
                @click="activeTab = 'all'; loadData()"
                :class="activeTab === 'all' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
            >
                All
                <span
                    class="ml-2 bg-gray-100 text-gray-600 py-0.5 px-2 rounded-full text-xs"
                    x-text="totalItems"
                ></span>
            </button>
            <button
                @click="activeTab = 'cleanup'; if (cleanupItems.length === 0) loadCleanup()"
                :class="activeTab === 'cleanup' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
            >
                Cleanup
                <span
                    class="ml-2 bg-yellow-100 text-yellow-600 py-0.5 px-2 rounded-full text-xs"
                    x-text="totalCleanupItems"
                ></span>
            </button>
            <button
                @click="activeTab = 'merge'; if (Object.keys(mergeGroups).length === 0) loadMergeSuggestions()"
                :class="activeTab === 'merge' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
            >
                Merge
                <span
                    class="ml-2 bg-purple-100 text-purple-600 py-0.5 px-2 rounded-full text-xs"
                    x-text="Object.keys(mergeGroups).length"
                ></span>
            </button>
        </nav>
    </div>

    <!-- Loading Indicator -->
    <div x-show="loading" class="flex justify-center py-8">
        <svg
            class="animate-spin h-8 w-8 text-blue-500"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
        >
            <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
            ></circle>
            <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
        </svg>
    </div>

    <!-- All Tab -->
    <div x-show="activeTab === 'all' && !loading " x-cloak>
        <!-- Toolbar -->
        <div class="mb-4 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <input
                    type="text"
                    x-model="filter"
                    @input.debounce.300ms="currentPage = 1; loadData()"
                    placeholder="Filter by name..."
                    class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500"
                />

                <select
                    x-model.number="pageSize"
                    @change="currentPage = 1; loadData()"
                    class="px-3 py-2 border border-gray-300 rounded-md text-sm"
                >
                    <option value="20">20 per page</option>
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                </select>
            </div>
        </div>

        <!-- Table -->
        <div class="bg-white shadow overflow-hidden rounded-lg">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th
                            @click="sortBy = sortBy === 'name' ? 'name-desc' : 'name'"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                        >
                            Name
                            <span x-show="sortBy === 'name'" class="ml-1"
                                >↑</span
                            >
                            <span x-show="sortBy === 'name-desc'" class="ml-1"
                                >↓</span
                            >
                        </th>
                        <th
                            x-show="metadataType === 'tags'"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                            Color
                        </th>
                        <th
                            @click="sortBy = sortBy === 'count' ? 'count-desc' : 'count'"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                        >
                            Documents
                            <span x-show="sortBy === 'count'" class="ml-1"
                                >↑</span
                            >
                            <span x-show="sortBy === 'count-desc'" class="ml-1"
                                >↓</span
                            >
                        </th>
                        <th
                            @click="sortBy = sortBy === 'match' ? 'match-desc' : 'match'"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                        >
                            Match Type
                            <span x-show="sortBy === 'match'" class="ml-1"
                                >↑</span
                            >
                            <span x-show="sortBy === 'match-desc'" class="ml-1"
                                >↓</span
                            >
                        </th>
                        <th
                            class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                            Actions
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="item in filteredItems" :key="item.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span
                                    class="text-sm font-medium text-gray-900"
                                    x-text="item.name"
                                ></span>
                            </td>
                            <td
                                x-show="metadataType === 'tags'"
                                class="px-6 py-4 whitespace-nowrap"
                            >
                                <span
                                    class="inline-block w-6 h-6 rounded"
                                    :style="`background-color: ${item.color}`"
                                ></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span
                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                    :class="item.document_count === 0 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'"
                                    x-text="item.document_count + ' docs'"
                                ></span>
                            </td>
                            <td
                                class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                x-text="item.match_type"
                            ></td>
                            <td
                                class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"
                            >
                                <button
                                    @click="editItem(item)"
                                    class="text-blue-600 hover:text-blue-900 mr-3"
                                >
                                    Edit
                                </button>
                                <button
                                    @click="deleteIndividualItem(item)"
                                    class="text-red-600 hover:text-red-900"
                                >
                                    Delete
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div
            class="mt-4 flex items-center justify-between"
            x-show="totalPages > 1"
        >
            <div class="text-sm text-gray-700">
                Page <span x-text="currentPage"></span> of
                <span x-text="totalPages"></span>
                (<span x-text="totalItems"></span> total)
            </div>
            <div class="flex space-x-2">
                <button
                    @click="loadData(currentPage - 1)"
                    :disabled="currentPage <= 1"
                    :class="currentPage <= 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-300'"
                    class="px-3 py-1 bg-gray-200 rounded text-sm"
                >
                    Previous
                </button>
                <button
                    @click="loadData(currentPage + 1)"
                    :disabled="currentPage >= totalPages"
                    :class="currentPage >= totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-300'"
                    class="px-3 py-1 bg-gray-200 rounded text-sm"
                >
                    Next
                </button>
            </div>
        </div>
    </div>

    <!-- Cleanup Tab -->
    <div x-show="activeTab === 'cleanup' && !loading " x-cloak>
        <!-- Toolbar -->
        <div class="mb-4 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <label class="flex items-center space-x-2">
                    <span class="text-sm text-gray-700">Show items with ≤</span>
                    <select
                        x-model="maxDocs"
                        @change="cleanupCurrentPage = 1; loadCleanup()"
                        class="px-2 py-1 border border-gray-300 rounded-md text-sm"
                    >
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="5">5</option>
                    </select>
                    <span class="text-sm text-gray-700">documents</span>
                </label>

                <label class="flex items-center space-x-2">
                    <input
                        type="checkbox"
                        x-model="excludeAuto"
                        @change="cleanupCurrentPage = 1; loadCleanup()"
                        class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    />
                    <span class="text-sm text-gray-700"
                        >Exclude auto-match</span
                    >
                </label>

                <span
                    x-show="metadataType === 'tags'"
                    class="text-sm text-gray-500"
                >
                    (excluding patterns: {{ exclude_patterns }})
                </span>

                <select
                    x-model.number="cleanupPageSize"
                    @change="cleanupCurrentPage = 1; loadCleanup()"
                    class="px-3 py-1.5 border border-gray-300 rounded-md text-sm"
                >
                    <option value="20">20 per page</option>
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                    <option
                        :value="totalCleanupItems"
                        x-show="totalCleanupItems > 0"
                    >
                        All
                    </option>
                </select>
            </div>

            <button
                @click="deleteSelectedItems()"
                :disabled="selectedItems.length === 0 || operationInProgress"
                :class="(selectedItems.length === 0 || operationInProgress) ? 'opacity-50 cursor-not-allowed' : 'hover:bg-red-700'"
                class="inline-flex items-center px-4 py-2 bg-red-600 text-white rounded-md text-sm"
            >
                Delete Selected (<span x-text="selectedItems.length"></span>)
            </button>
        </div>

        <!-- Progress Bar -->
        <div
            x-show="operationInProgress"
            class="mb-4 bg-white shadow rounded-lg p-4"
        >
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-600"
                    >Processing... <span x-text="operationProgress"></span> /
                    <span x-text="operationTotal"></span
                ></span>
                <span
                    class="text-sm text-gray-600"
                    x-text="operationTotal > 0 ? Math.round((operationProgress / operationTotal) * 100) + '%' : ''"
                ></span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div
                    class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                    :style="`width: ${operationTotal > 0 ? (operationProgress / operationTotal) * 100 : 0}%`"
                ></div>
            </div>
        </div>

        <!-- Table -->
        <div class="bg-white shadow overflow-hidden rounded-lg">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left">
                            <label class="inline-flex items-center">
                                <input
                                    type="checkbox"
                                    @change="selectedItems = $event.target.checked ? cleanupItems.map(i => i.id) : []"
                                    :checked="selectedItems.length === cleanupItems.length && cleanupItems.length > 0"
                                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                />
                                <span class="ml-2 text-xs text-gray-500"
                                    >Select All</span
                                >
                            </label>
                        </th>
                        <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                            Name
                        </th>
                        <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                            Documents
                        </th>
                        <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                            Match Type
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="item in cleanupItems" :key="item.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <input
                                    type="checkbox"
                                    :value="item.id"
                                    x-model="selectedItems"
                                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                />
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span
                                    class="text-sm font-medium text-gray-900"
                                    x-text="item.name"
                                ></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span
                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800"
                                    x-text="item.document_count + ' docs'"
                                ></span>
                            </td>
                            <td
                                class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                            >
                                <span x-text="item.match_type"></span>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Empty State -->
        <div
            x-show="cleanupItems.length === 0"
            class="text-center py-8 text-gray-500"
        >
            No items found with ≤ <span x-text="maxDocs"></span> documents.
        </div>

        <!-- Pagination -->
        <div
            class="mt-4 flex items-center justify-between"
            x-show="cleanupTotalPages > 1"
        >
            <div class="text-sm text-gray-700">
                Page <span x-text="cleanupCurrentPage"></span> of
                <span x-text="cleanupTotalPages"></span>
                (<span x-text="totalCleanupItems"></span> total)
            </div>
            <div class="flex space-x-2">
                <button
                    @click="loadCleanup(cleanupCurrentPage - 1)"
                    :disabled="cleanupCurrentPage <= 1"
                    :class="cleanupCurrentPage <= 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-300'"
                    class="px-3 py-1 bg-gray-200 rounded text-sm"
                >
                    Previous
                </button>
                <button
                    @click="loadCleanup(cleanupCurrentPage + 1)"
                    :disabled="cleanupCurrentPage >= cleanupTotalPages"
                    :class="cleanupCurrentPage >= cleanupTotalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-300'"
                    class="px-3 py-1 bg-gray-200 rounded text-sm"
                >
                    Next
                </button>
            </div>
        </div>
    </div>

    <!-- Merge Tab -->
    <div x-show="activeTab === 'merge' && !loading " x-cloak>
        <!-- Selected Items for Merge (always visible at top) -->
        <div class="mb-6 bg-white shadow rounded-lg p-4">
            <div class="flex items-center justify-between mb-3">
                <h4 class="text-md font-medium text-gray-900">
                    Selected for Merge
                    <span
                        class="text-sm font-normal text-gray-500"
                        x-text="`(${mergeSelectedItems.length} items)`"
                    ></span>
                </h4>
                <button
                    x-show="mergeSelectedItems.length > 0"
                    @click="clearMergeSelection()"
                    class="text-sm text-gray-500 hover:text-gray-700"
                >
                    Clear All
                </button>
            </div>

            <!-- Selected Items Pills -->
            <div x-show="mergeSelectedItems.length > 0" class="mb-4">
                <div class="flex flex-wrap gap-2 max-h-48 overflow-y-auto">
                    <template
                        x-for="itemId in mergeSelectedItems"
                        :key="itemId"
                    >
                        <span
                            @click="toggleMergeItem(itemId)"
                            class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium cursor-pointer transition-all"
                            :style="metadataType === 'tags' && getMergeItemColor(itemId)
                                ? `background-color: ${getMergeItemColor(itemId)}20; color: ${getMergeItemColor(itemId)}; border: 1px solid ${getMergeItemColor(itemId)}`
                                : 'background-color: #ddd6fe; color: #6d28d9; border: 1px solid #a78bfa'"
                        >
                            <span x-text="getMergeItemName(itemId)"></span>
                            <span
                                class="ml-1 opacity-75"
                                x-text="`(${getMergeItemDocCount(itemId)})`"
                            ></span>
                            <span class="ml-1 hover:text-red-600">&times;</span>
                        </span>
                    </template>
                </div>
            </div>

            <!-- Empty state -->
            <div
                x-show="mergeSelectedItems.length === 0"
                class="text-sm text-gray-500 mb-4"
            >
                Click on suggestion groups below or use the custom search to
                select items to merge.
            </div>

            <!-- Target name and merge button -->
            <div class="flex items-center space-x-2">
                <input
                    type="text"
                    x-model="mergeTargetName"
                    placeholder="Target name for merged item..."
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-purple-500 focus:border-purple-500"
                />
                <button
                    @click="performMerge()"
                    :disabled="mergeSelectedItems.length < 2 || !mergeTargetName || operationInProgress"
                    :class="(mergeSelectedItems.length < 2 || !mergeTargetName || operationInProgress) ? 'opacity-50 cursor-not-allowed' : 'hover:bg-purple-700'"
                    class="inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded-md text-sm"
                >
                    <svg
                        x-show="operationInProgress"
                        class="animate-spin -ml-1 mr-2 h-4 w-4 text-white"
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                    >
                        <circle
                            class="opacity-25"
                            cx="12"
                            cy="12"
                            r="10"
                            stroke="currentColor"
                            stroke-width="4"
                        ></circle>
                        <path
                            class="opacity-75"
                            fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                        ></path>
                    </svg>
                    Merge Selected
                </button>
            </div>

            <!-- Progress Bar -->
            <div
                x-show="operationInProgress"
                class="mt-4 bg-gray-50 rounded-lg p-3"
            >
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-600">Processing...</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div
                        class="bg-purple-600 h-2 rounded-full animate-pulse"
                        style="width: 100%"
                    ></div>
                </div>
            </div>
        </div>

        <!-- Custom Selection Search -->
        <div class="mb-6 bg-white shadow rounded-lg p-4">
            <h4 class="text-md font-medium text-gray-900 mb-3">
                Custom Selection
            </h4>
            <div class="space-y-3">
                <input
                    type="text"
                    x-model="customMergeSearch"
                    @input.debounce.300ms="searchItemsForCustomMerge()"
                    placeholder="Search items to add to merge selection..."
                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-purple-500 focus:border-purple-500"
                />

                <!-- Search Results -->
                <div
                    x-show="customMergeSearchResults.length > 0"
                    class="max-h-48 overflow-y-auto border border-gray-300 rounded-md bg-gray-50"
                >
                    <template
                        x-for="item in customMergeSearchResults"
                        :key="item.id"
                    >
                        <div
                            @click="addItemToMergeSelection(item)"
                            class="px-3 py-2 hover:bg-gray-100 flex items-center justify-between border-b last:border-b-0 cursor-pointer"
                            :class="mergeSelectedItems.includes(item.id) ? 'bg-purple-50' : ''"
                        >
                            <div class="flex items-center space-x-2">
                                <span
                                    class="inline-block w-4 h-4 rounded"
                                    :class="mergeSelectedItems.includes(item.id) ? 'bg-purple-600' : 'border border-gray-300'"
                                >
                                    <svg
                                        x-show="mergeSelectedItems.includes(item.id)"
                                        class="w-4 h-4 text-white"
                                        fill="currentColor"
                                        viewBox="0 0 20 20"
                                    >
                                        <path
                                            fill-rule="evenodd"
                                            d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                            clip-rule="evenodd"
                                        />
                                    </svg>
                                </span>
                                <span class="text-sm" x-text="item.name"></span>
                                <span
                                    class="text-xs text-gray-500"
                                    x-text="`(${item.document_count} docs)`"
                                ></span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Prefix Filter for Suggestions -->
        <div class="mb-4 flex items-center space-x-4">
            <input
                type="text"
                x-model="mergePrefix"
                @keyup.enter="loadMergeSuggestions()"
                placeholder="Filter suggestions by prefix (e.g., 'account')..."
                class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-purple-500 focus:border-purple-500"
            />
            <button
                @click="loadMergeSuggestions()"
                class="px-4 py-2 bg-purple-600 text-white rounded-md text-sm hover:bg-purple-700"
            >
                Find Suggestions
            </button>
            <span
                x-show="metadataType === 'tags'"
                class="text-sm text-gray-500"
            >
                (excluding auto-match items and patterns: {{ exclude_patterns
                }})
            </span>
        </div>

        <!-- Merge Suggestion Groups -->
        <div class="space-y-4">
            <template x-for="(group, prefix) in mergeGroups" :key="prefix">
                <div
                    @click="selectGroupForMerge(prefix, group, $event)"
                    class="bg-white shadow rounded-lg p-4 cursor-pointer hover:ring-2 hover:ring-purple-300 transition-all"
                    :class="isGroupSelected(prefix) ? 'ring-2 ring-purple-500' : ''"
                >
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <h4 class="text-lg font-medium text-gray-900">
                                "<span x-text="prefix"></span>..."
                            </h4>
                            <span
                                class="text-sm text-gray-500"
                                x-text="`${group[itemKey].length} items, ${group.total_documents} total docs`"
                            ></span>
                            <span
                                x-show="isGroupSelected(prefix)"
                                class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800"
                            >
                                Selected
                            </span>
                        </div>
                        <span class="text-sm text-purple-600"
                            >Click to add all items</span
                        >
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <template x-for="item in group[itemKey]" :key="item.id">
                            <span
                                @click.stop="addItemToMergeSelection(item)"
                                class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium cursor-pointer transition-all hover:ring-2 hover:ring-purple-300"
                                :class="mergeSelectedItems.includes(item.id) ? 'ring-2 ring-purple-400' : ''"
                                :style="metadataType === 'tags'
                                    ? `background-color: ${item.color}20; color: ${item.color}; border: 1px solid ${item.color}`
                                    : 'background-color: #e5e7eb; color: #374151; border: 1px solid #d1d5db'"
                            >
                                <span x-text="item.name"></span>
                                <span
                                    class="ml-1 opacity-75"
                                    x-text="`(${item.document_count})`"
                                ></span>
                            </span>
                        </template>
                    </div>
                </div>
            </template>
        </div>

        <!-- Empty State -->
        <div
            x-show="Object.keys(mergeGroups).length === 0"
            class="text-center py-8 text-gray-500"
        >
            No merge suggestions found. Try adjusting the prefix filter or use
            the custom search above.
        </div>
    </div>

    <!-- Edit Modal -->
    <div
        x-show="showEditModal"
        x-cloak
        class="fixed inset-0 z-50 overflow-y-auto"
        aria-labelledby="modal-title"
        role="dialog"
        aria-modal="true"
    >
        <div
            class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"
        >
            <div
                class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
                @click="showEditModal = false"
            ></div>
            <span
                class="hidden sm:inline-block sm:align-middle sm:h-screen"
                aria-hidden="true"
                >&#8203;</span
            >
            <div
                class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"
            >
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3
                        class="text-lg leading-6 font-medium text-gray-900 mb-4"
                        x-text="editModalTitle"
                    ></h3>
                    <div class="space-y-4">
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700"
                                >Name</label
                            >
                            <input
                                type="text"
                                x-model="editForm.name"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                            />
                        </div>
                        <div x-show="metadataType === 'tags'">
                            <label
                                class="block text-sm font-medium text-gray-700"
                                >Color</label
                            >
                            <div class="mt-1 flex items-center space-x-2">
                                <input
                                    type="color"
                                    x-model="editForm.color"
                                    class="h-10 w-20 rounded border border-gray-300"
                                />
                                <span
                                    class="text-sm text-gray-500"
                                    x-text="editForm.color"
                                ></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div
                    class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"
                >
                    <button
                        type="button"
                        @click="saveEdit()"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm"
                    >
                        Save
                    </button>
                    <button
                        type="button"
                        @click="showEditModal = false"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div
        x-show="showConfirm"
        x-cloak
        class="fixed inset-0 z-50 overflow-y-auto"
        aria-labelledby="modal-title"
        role="dialog"
        aria-modal="true"
    >
        <div
            class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"
        >
            <div
                class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
            ></div>
            <span
                class="hidden sm:inline-block sm:align-middle sm:h-screen"
                aria-hidden="true"
                >&#8203;</span
            >
            <div
                class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"
            >
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div
                            class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10"
                        >
                            <svg
                                class="h-6 w-6 text-red-600"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                                />
                            </svg>
                        </div>
                        <div
                            class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left"
                        >
                            <h3
                                class="text-lg leading-6 font-medium text-gray-900"
                                x-text="confirmTitle"
                            ></h3>
                            <div class="mt-2">
                                <p
                                    class="text-sm text-gray-500 whitespace-pre-wrap"
                                    x-text="confirmMessage"
                                ></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div
                    class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"
                >
                    <button
                        type="button"
                        @click="confirmAction(); showConfirm = false"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm"
                    >
                        Confirm
                    </button>
                    <button
                        type="button"
                        @click="showConfirm = false"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function metadataManager() {
        return {
            // Core state
            metadataType: "tags",
            activeTab: "all",
            loading: false,
            operationInProgress: false,
            operationProgress: 0,
            operationTotal: 0,
            // Data arrays
            items: [],
            cleanupItems: [],
            mergeGroups: {},
            selectedItems: [],
            selectedGroups: [],

            // Filtering/sorting
            filter: "",
            sortBy: "name",
            maxDocs: "0",
            excludeAuto: true,
            mergePrefix: "",

            // Merge selection state (unified)
            mergeSelectedItems: [],
            mergeItemCache: {}, // Cache item details (name, color, doc_count) by id
            mergeTargetName: "",
            customMergeSearch: "",
            customMergeSearchResults: [],

            // Pagination state (All tab)
            currentPage: 1,
            pageSize: 50,
            totalPages: 1,
            totalItems: 0,

            // Pagination state (Cleanup tab)
            cleanupCurrentPage: 1,
            cleanupPageSize: 50,
            cleanupTotalPages: 1,
            totalCleanupItems: 0,

            // Modals
            showConfirm: false,
            confirmTitle: "",
            confirmMessage: "",
            confirmAction: () => {},

            showEditModal: false,
            editModalTitle: "",
            editId: null,
            editForm: {
                name: "",
                color: "",
            },

            // Computed
            get apiEndpoint() {
                if (this.metadataType === "tags") return "/api/tags";
                if (this.metadataType === "correspondents")
                    return "/api/correspondents";
                if (this.metadataType === "document_types")
                    return "/api/document_types";
                return null;
            },

            get itemKey() {
                if (this.metadataType === "tags") return "tags";
                if (this.metadataType === "correspondents")
                    return "correspondents";
                if (this.metadataType === "document_types")
                    return "document_types";
                return "items";
            },

            get itemIdKey() {
                if (this.metadataType === "correspondents")
                    return "correspondent_ids";
                if (this.metadataType === "document_types")
                    return "document_type_ids";
                return "tag_ids";
            },

            get filteredItems() {
                let result = [...this.items];

                // Sorting only - filtering is done server-side
                if (this.sortBy === "name") {
                    result.sort((a, b) => a.name.localeCompare(b.name));
                } else if (this.sortBy === "name-desc") {
                    result.sort((a, b) => b.name.localeCompare(a.name));
                } else if (this.sortBy === "count") {
                    result.sort((a, b) => a.document_count - b.document_count);
                } else if (this.sortBy === "count-desc") {
                    result.sort((a, b) => b.document_count - a.document_count);
                } else if (this.sortBy === "match") {
                    result.sort((a, b) =>
                        a.match_type.localeCompare(b.match_type),
                    );
                } else if (this.sortBy === "match-desc") {
                    result.sort((a, b) =>
                        b.match_type.localeCompare(a.match_type),
                    );
                }

                return result;
            },

            // Methods
            async init() {
                await this.loadData();
            },

            onMetadataTypeChange() {
                // Reset state when switching metadata types
                this.activeTab = "all";
                this.items = [];
                this.cleanupItems = [];
                this.mergeGroups = {};
                this.selectedItems = [];
                this.currentPage = 1;
                this.cleanupCurrentPage = 1;
                this.totalItems = 0;
                this.totalCleanupItems = 0;
                this.filter = "";
                this.mergeSelectedItems = [];
                this.mergeItemCache = {};
                this.mergeTargetName = "";
                this.customMergeSearch = "";
                this.customMergeSearchResults = [];
                this.loadData();
            },

            async loadData(page = null) {
                if (!this.apiEndpoint) return;

                this.loading = true;
                if (page !== null) {
                    this.currentPage = page;
                }
                try {
                    let url = `${this.apiEndpoint}?page=${this.currentPage}&page_size=${this.pageSize}`;
                    if (this.filter) {
                        url += `&filter=${encodeURIComponent(this.filter)}`;
                    }
                    const resp = await fetch(url);
                    const data = await resp.json();
                    this.items = data[this.itemKey];
                    this.totalPages = data.total_pages;
                    this.totalItems = data.total;
                } catch (e) {
                    showToast("Failed to load data: " + e.message, "error");
                }
                this.loading = false;
            },

            async loadCleanup(page = null) {
                if (!this.apiEndpoint) return;

                this.loading = true;
                this.selectedItems = [];
                if (page !== null) {
                    this.cleanupCurrentPage = page;
                }
                try {
                    const resp = await fetch(
                        `${this.apiEndpoint}/low-usage?max_docs=${this.maxDocs}&page=${this.cleanupCurrentPage}&page_size=${this.cleanupPageSize}&exclude_auto=${this.excludeAuto}`,
                    );
                    const data = await resp.json();
                    this.cleanupItems = data[this.itemKey];
                    this.cleanupTotalPages = data.total_pages;
                    this.totalCleanupItems = data.total;
                } catch (e) {
                    showToast(
                        "Failed to load cleanup items: " + e.message,
                        "error",
                    );
                }
                this.loading = false;
            },

            async loadMergeSuggestions() {
                if (!this.apiEndpoint) return;

                this.loading = true;
                try {
                    let url = `${this.apiEndpoint}/merge-suggestions`;
                    if (this.mergePrefix) {
                        url += `?prefix=${encodeURIComponent(this.mergePrefix)}`;
                    }
                    const resp = await fetch(url);
                    const data = await resp.json();
                    this.mergeGroups = data.groups;

                    // Cache all items from groups for display
                    for (const prefix in this.mergeGroups) {
                        const group = this.mergeGroups[prefix];
                        for (const item of group[this.itemKey]) {
                            this.mergeItemCache[item.id] = {
                                name: item.name,
                                color: item.color,
                                document_count: item.document_count,
                            };
                        }
                    }
                } catch (e) {
                    showToast(
                        "Failed to load suggestions: " + e.message,
                        "error",
                    );
                }
                this.loading = false;
            },

            editItem(item) {
                this.editId = item.id;
                this.editModalTitle = `Edit ${this.metadataType === "tags" ? "Tag" : this.metadataType === "correspondents" ? "Correspondent" : "Document Type"}`;
                this.editForm.name = item.name;
                this.editForm.color = item.color || "#a6cee3";
                this.showEditModal = true;
            },

            async saveEdit() {
                if (!this.editForm.name.trim()) {
                    showToast("Name cannot be empty", "error");
                    return;
                }

                try {
                    const body =
                        this.metadataType === "tags"
                            ? {
                                  name: this.editForm.name,
                                  color: this.editForm.color,
                              }
                            : { name: this.editForm.name };

                    const resp = await fetch(
                        `${this.apiEndpoint}/${this.editId}`,
                        {
                            method: "PATCH",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(body),
                        },
                    );

                    if (!resp.ok) {
                        const err = await resp.json();
                        throw new Error(err.detail || "Update failed");
                    }

                    showToast("Updated successfully", "success");
                    this.showEditModal = false;
                    this.loadData();
                } catch (e) {
                    showToast("Failed to update: " + e.message, "error");
                }
            },

            deleteIndividualItem(item) {
                this.confirmTitle = `Delete "${item.name}"?`;
                this.confirmMessage = `This will permanently delete this item. Documents will not be affected.`;
                this.confirmAction = async () => {
                    try {
                        const resp = await fetch(`${this.apiEndpoint}/delete`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                [this.itemIdKey]: [item.id],
                            }),
                        });

                        if (!resp.ok) {
                            const err = await resp.json();
                            throw new Error(err.detail || "Delete failed");
                        }

                        showToast("Deleted successfully", "success");
                        this.loadData();
                    } catch (e) {
                        showToast("Failed to delete: " + e.message, "error");
                    }
                };
                this.showConfirm = true;
            },

            async deleteSelectedItems() {
                if (this.selectedItems.length === 0) return;

                this.confirmTitle = `Delete ${this.selectedItems.length} items?`;
                this.confirmMessage = `This will permanently delete these items. Documents will not be affected.`;
                this.confirmAction = async () => {
                    this.operationInProgress = true;
                    this.operationProgress = 0;
                    this.operationTotal = this.selectedItems.length;

                    const batchSize = 10;
                    const batches = [];
                    for (
                        let i = 0;
                        i < this.selectedItems.length;
                        i += batchSize
                    ) {
                        batches.push(
                            this.selectedItems.slice(i, i + batchSize),
                        );
                    }

                    try {
                        for (const batch of batches) {
                            const resp = await fetch(
                                `${this.apiEndpoint}/delete`,
                                {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify({
                                        [this.itemIdKey]: batch,
                                    }),
                                },
                            );

                            if (!resp.ok) {
                                const err = await resp.json();
                                throw new Error(err.detail || "Delete failed");
                            }

                            this.operationProgress += batch.length;
                        }

                        showToast(
                            `Deleted ${this.selectedItems.length} items`,
                            "success",
                        );
                        this.selectedItems = [];
                        this.loadCleanup();
                    } catch (e) {
                        showToast("Failed to delete: " + e.message, "error");
                    }

                    this.operationInProgress = false;
                };
                this.showConfirm = true;
            },

            // Merge selection helper methods
            getMergeItemName(id) {
                return this.mergeItemCache[id]?.name || `ID: ${id}`;
            },

            getMergeItemColor(id) {
                return this.mergeItemCache[id]?.color || null;
            },

            getMergeItemDocCount(id) {
                return this.mergeItemCache[id]?.document_count ?? 0;
            },

            toggleMergeItem(itemId) {
                const index = this.mergeSelectedItems.indexOf(itemId);
                if (index > -1) {
                    this.mergeSelectedItems.splice(index, 1);
                } else {
                    this.mergeSelectedItems.push(itemId);
                }
            },

            clearMergeSelection() {
                this.mergeSelectedItems = [];
                this.mergeTargetName = "";
            },

            addItemToMergeSelection(item) {
                // Cache item details
                this.mergeItemCache[item.id] = {
                    name: item.name,
                    color: item.color,
                    document_count: item.document_count,
                };

                // Toggle selection
                const index = this.mergeSelectedItems.indexOf(item.id);
                if (index > -1) {
                    this.mergeSelectedItems.splice(index, 1);
                } else {
                    this.mergeSelectedItems.push(item.id);
                }
            },

            selectGroupForMerge(prefix, group, event) {
                // Add all items from this group to selection
                for (const item of group[this.itemKey]) {
                    // Cache item details
                    this.mergeItemCache[item.id] = {
                        name: item.name,
                        color: item.color,
                        document_count: item.document_count,
                    };

                    // Add to selection if not already there
                    if (!this.mergeSelectedItems.includes(item.id)) {
                        this.mergeSelectedItems.push(item.id);
                    }
                }

                // Auto-suggest target name from group
                if (!this.mergeTargetName) {
                    this.mergeTargetName = group.suggested_name || prefix;
                }
            },

            isGroupSelected(prefix) {
                const group = this.mergeGroups[prefix];
                if (!group) return false;
                // A group is "selected" if all its items are in the selection
                return group[this.itemKey].every((item) =>
                    this.mergeSelectedItems.includes(item.id),
                );
            },

            async searchItemsForCustomMerge() {
                if (this.customMergeSearch.length < 2) {
                    this.customMergeSearchResults = [];
                    return;
                }

                try {
                    const url = `${this.apiEndpoint}?page=1&page_size=20&filter=${encodeURIComponent(this.customMergeSearch)}`;
                    const resp = await fetch(url);
                    const data = await resp.json();
                    this.customMergeSearchResults = data[this.itemKey];

                    // Cache item details for display
                    for (const item of this.customMergeSearchResults) {
                        this.mergeItemCache[item.id] = {
                            name: item.name,
                            color: item.color,
                            document_count: item.document_count,
                        };
                    }
                } catch (e) {
                    console.error("Failed to search items:", e);
                    this.customMergeSearchResults = [];
                }
            },

            performMerge() {
                if (
                    this.mergeSelectedItems.length < 2 ||
                    !this.mergeTargetName
                ) {
                    showToast(
                        "Select at least 2 items and provide a target name",
                        "error",
                    );
                    return;
                }

                const itemCount = this.mergeSelectedItems.length;
                const targetName = this.mergeTargetName;
                const itemNames = this.mergeSelectedItems
                    .map((id) => this.getMergeItemName(id))
                    .join(", ");

                this.confirmTitle = `Merge ${itemCount} items?`;
                this.confirmMessage = `This will merge the following into "${targetName}":\n\n${itemNames}\n\nThis action cannot be undone.`;
                this.confirmAction = async () => {
                    this.operationInProgress = true;
                    try {
                        const resp = await fetch(`${this.apiEndpoint}/merge`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                source_ids: this.mergeSelectedItems,
                                target_name: this.mergeTargetName,
                            }),
                        });

                        if (!resp.ok) {
                            const err = await resp.json();
                            throw new Error(err.detail || "Merge failed");
                        }

                        const result = await resp.json();
                        showToast(result.message, "success");

                        // Clear selection and reload
                        this.mergeSelectedItems = [];
                        this.mergeTargetName = "";
                        this.customMergeSearch = "";
                        this.customMergeSearchResults = [];
                        this.loadData();
                        this.loadMergeSuggestions();
                    } catch (e) {
                        showToast("Failed to merge: " + e.message, "error");
                    }
                    this.operationInProgress = false;
                };
                this.showConfirm = true;
            },
        };
    }
</script>
{% endblock %}
