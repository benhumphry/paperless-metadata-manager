{% extends "base.html" %} {% block content %}
<div x-data="metadataManager()" x-init="init()">
    <!-- Metadata Type Selector -->
    <div class="mb-6 bg-white shadow rounded-lg p-4">
        <label class="block text-sm font-medium text-gray-700 mb-2"
            >Metadata Type</label
        >
        <select
            x-model="metadataType"
            @change="onMetadataTypeChange()"
            class="w-full max-w-xs px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500"
        >
            <option value="tags">Tags</option>
            <option value="correspondents">Correspondents</option>
            <option value="document_types">Document Types</option>
            <template x-for="field in customFields" :key="field.id">
                <option
                    :value="'custom_field_' + field.id"
                    x-text="'Custom Field: ' + field.name"
                ></option>
            </template>
        </select>
    </div>

    <!-- Tabs -->
    <div class="mb-6 border-b border-gray-200">
        <nav class="-mb-px flex space-x-8">
            <button
                @click="activeTab = 'all'; loadData()"
                :class="activeTab === 'all' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
            >
                All
                <span
                    class="ml-2 bg-gray-100 text-gray-600 py-0.5 px-2 rounded-full text-xs"
                    x-text="totalItems"
                ></span>
            </button>
            <button
                @click="activeTab = 'cleanup'; if (cleanupItems.length === 0) loadCleanup()"
                :class="activeTab === 'cleanup' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
            >
                Cleanup
                <span
                    class="ml-2 bg-yellow-100 text-yellow-600 py-0.5 px-2 rounded-full text-xs"
                    x-text="totalCleanupItems"
                ></span>
            </button>
            <button
                @click="activeTab = 'merge'; if (Object.keys(mergeGroups).length === 0) loadMergeSuggestions()"
                :class="activeTab === 'merge' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
            >
                Merge
                <span
                    class="ml-2 bg-purple-100 text-purple-600 py-0.5 px-2 rounded-full text-xs"
                    x-text="Object.keys(mergeGroups).length"
                ></span>
            </button>
        </nav>
    </div>

    <!-- Loading Indicator -->
    <div x-show="loading" class="flex justify-center py-8">
        <svg
            class="animate-spin h-8 w-8 text-blue-500"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
        >
            <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
            ></circle>
            <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
        </svg>
    </div>

    <!-- Not Implemented Message for Custom Fields -->
    <div
        x-show="isCustomField && !loading"
        x-cloak
        class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center"
    >
        <svg
            class="mx-auto h-12 w-12 text-yellow-400"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
        >
            <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
            />
        </svg>
        <h3 class="mt-4 text-lg font-medium text-yellow-800">
            Custom Field Management
        </h3>
        <p class="mt-2 text-sm text-yellow-600">
            Management of custom fields is not yet implemented. This feature
            will be available in a future update.
        </p>
    </div>

    <!-- All Tab -->
    <div x-show="activeTab === 'all' && !loading && !isCustomField" x-cloak>
        <!-- Toolbar -->
        <div class="mb-4 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <input
                    type="text"
                    x-model="filter"
                    @input.debounce.300ms="currentPage = 1; loadData()"
                    placeholder="Filter by name..."
                    class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500"
                />
                <select
                    x-model="sortBy"
                    class="px-3 py-2 border border-gray-300 rounded-md text-sm"
                >
                    <option value="name">Sort by Name</option>
                    <option value="count">Sort by Count (Asc)</option>
                    <option value="count-desc">Sort by Count (Desc)</option>
                </select>
                <select
                    x-model.number="pageSize"
                    @change="currentPage = 1; loadData()"
                    class="px-3 py-2 border border-gray-300 rounded-md text-sm"
                >
                    <option value="20">20 per page</option>
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                </select>
            </div>
        </div>

        <!-- Table -->
        <div class="bg-white shadow overflow-hidden rounded-lg">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                            Name
                        </th>
                        <th
                            x-show="metadataType === 'tags'"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                            Color
                        </th>
                        <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                            Documents
                        </th>
                        <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                            Match Type
                        </th>
                        <th
                            class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                            Actions
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="item in filteredItems" :key="item.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span
                                    class="text-sm font-medium text-gray-900"
                                    x-text="item.name"
                                ></span>
                            </td>
                            <td
                                x-show="metadataType === 'tags'"
                                class="px-6 py-4 whitespace-nowrap"
                            >
                                <span
                                    class="inline-block w-6 h-6 rounded"
                                    :style="`background-color: ${item.color}`"
                                ></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span
                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                    :class="item.document_count === 0 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'"
                                    x-text="item.document_count + ' docs'"
                                ></span>
                            </td>
                            <td
                                class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                            >
                                <span x-text="item.match_type"></span>
                                <span
                                    x-show="item.is_auto"
                                    class="ml-1 text-xs text-blue-600"
                                    >(auto)</span
                                >
                            </td>
                            <td
                                class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"
                            >
                                <button
                                    @click="editItem(item)"
                                    class="text-blue-600 hover:text-blue-900 mr-3"
                                >
                                    Edit
                                </button>
                                <button
                                    @click="deleteIndividualItem(item)"
                                    class="text-red-600 hover:text-red-900"
                                >
                                    Delete
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div
            class="mt-4 flex items-center justify-between"
            x-show="totalPages > 1"
        >
            <div class="text-sm text-gray-700">
                Page <span x-text="currentPage"></span> of
                <span x-text="totalPages"></span>
                (<span x-text="totalItems"></span> total)
            </div>
            <div class="flex space-x-2">
                <button
                    @click="loadData(currentPage - 1)"
                    :disabled="currentPage <= 1"
                    :class="currentPage <= 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-300'"
                    class="px-3 py-1 bg-gray-200 rounded text-sm"
                >
                    Previous
                </button>
                <button
                    @click="loadData(currentPage + 1)"
                    :disabled="currentPage >= totalPages"
                    :class="currentPage >= totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-300'"
                    class="px-3 py-1 bg-gray-200 rounded text-sm"
                >
                    Next
                </button>
            </div>
        </div>
    </div>

    <!-- Cleanup Tab -->
    <div x-show="activeTab === 'cleanup' && !loading && !isCustomField" x-cloak>
        <!-- Toolbar -->
        <div class="mb-4 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <label class="flex items-center space-x-2">
                    <span class="text-sm text-gray-700">Show items with ≤</span>
                    <select
                        x-model="maxDocs"
                        @change="cleanupCurrentPage = 1; loadCleanup()"
                        class="px-2 py-1 border border-gray-300 rounded-md text-sm"
                    >
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="5">5</option>
                    </select>
                    <span class="text-sm text-gray-700">documents</span>
                </label>

                <span
                    x-show="metadataType === 'tags'"
                    class="text-sm text-gray-500"
                >
                    (excluding auto-match items and patterns: {{
                    exclude_patterns }})
                </span>

                <select
                    x-model.number="cleanupPageSize"
                    @change="cleanupCurrentPage = 1; loadCleanup()"
                    class="px-3 py-1.5 border border-gray-300 rounded-md text-sm"
                >
                    <option value="20">20 per page</option>
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                    <option
                        :value="totalCleanupItems"
                        x-show="totalCleanupItems > 0"
                    >
                        All
                    </option>
                </select>
            </div>

            <button
                @click="deleteSelectedItems()"
                :disabled="selectedItems.length === 0 || operationInProgress"
                :class="(selectedItems.length === 0 || operationInProgress) ? 'opacity-50 cursor-not-allowed' : 'hover:bg-red-700'"
                class="inline-flex items-center px-4 py-2 bg-red-600 text-white rounded-md text-sm"
            >
                Delete Selected (<span x-text="selectedItems.length"></span>)
            </button>
        </div>

        <!-- Progress Bar -->
        <div
            x-show="operationInProgress"
            class="mb-4 bg-white shadow rounded-lg p-4"
        >
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-600"
                    >Processing... <span x-text="operationProgress"></span> /
                    <span x-text="operationTotal"></span
                ></span>
                <span
                    class="text-sm text-gray-600"
                    x-text="operationTotal > 0 ? Math.round((operationProgress / operationTotal) * 100) + '%' : ''"
                ></span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div
                    class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                    :style="`width: ${operationTotal > 0 ? (operationProgress / operationTotal) * 100 : 0}%`"
                ></div>
            </div>
        </div>

        <!-- Table -->
        <div class="bg-white shadow overflow-hidden rounded-lg">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left">
                            <label class="inline-flex items-center">
                                <input
                                    type="checkbox"
                                    @change="selectedItems = $event.target.checked ? cleanupItems.map(i => i.id) : []"
                                    :checked="selectedItems.length === cleanupItems.length && cleanupItems.length > 0"
                                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                />
                                <span class="ml-2 text-xs text-gray-500"
                                    >Select All</span
                                >
                            </label>
                        </th>
                        <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                            Name
                        </th>
                        <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                            Documents
                        </th>
                        <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                            Match Type
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="item in cleanupItems" :key="item.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <input
                                    type="checkbox"
                                    :value="item.id"
                                    x-model="selectedItems"
                                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                />
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span
                                    class="text-sm font-medium text-gray-900"
                                    x-text="item.name"
                                ></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span
                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800"
                                    x-text="item.document_count + ' docs'"
                                ></span>
                            </td>
                            <td
                                class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                            >
                                <span x-text="item.match_type"></span>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Empty State -->
        <div
            x-show="cleanupItems.length === 0"
            class="text-center py-8 text-gray-500"
        >
            No items found with ≤ <span x-text="maxDocs"></span> documents.
        </div>

        <!-- Pagination -->
        <div
            class="mt-4 flex items-center justify-between"
            x-show="cleanupTotalPages > 1"
        >
            <div class="text-sm text-gray-700">
                Page <span x-text="cleanupCurrentPage"></span> of
                <span x-text="cleanupTotalPages"></span>
                (<span x-text="totalCleanupItems"></span> total)
            </div>
            <div class="flex space-x-2">
                <button
                    @click="loadCleanup(cleanupCurrentPage - 1)"
                    :disabled="cleanupCurrentPage <= 1"
                    :class="cleanupCurrentPage <= 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-300'"
                    class="px-3 py-1 bg-gray-200 rounded text-sm"
                >
                    Previous
                </button>
                <button
                    @click="loadCleanup(cleanupCurrentPage + 1)"
                    :disabled="cleanupCurrentPage >= cleanupTotalPages"
                    :class="cleanupCurrentPage >= cleanupTotalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-300'"
                    class="px-3 py-1 bg-gray-200 rounded text-sm"
                >
                    Next
                </button>
            </div>
        </div>
    </div>

    <!-- Merge Tab -->
    <div x-show="activeTab === 'merge' && !loading && !isCustomField" x-cloak>
        <!-- Custom Merge Section -->
        <div class="mb-6 bg-white shadow rounded-lg p-4">
            <h4 class="text-md font-medium text-gray-900 mb-3">Custom Merge</h4>
            <div class="space-y-3">
                <div class="flex items-center space-x-2">
                    <input
                        type="text"
                        x-model="customMergeSearch"
                        @input.debounce.300ms="searchItemsForCustomMerge()"
                        placeholder="Search items to merge..."
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500"
                    />
                    <span class="text-sm text-gray-500">
                        <span x-text="customMergeSelectedItems.length"></span>
                        selected
                    </span>
                </div>

                <!-- Search Results -->
                <div
                    x-show="customMergeSearchResults.length > 0"
                    class="max-h-48 overflow-y-auto border border-gray-300 rounded-md bg-gray-50"
                >
                    <template
                        x-for="item in customMergeSearchResults"
                        :key="item.id"
                    >
                        <div
                            class="px-3 py-2 hover:bg-gray-100 flex items-center justify-between border-b last:border-b-0"
                        >
                            <div class="flex items-center space-x-2">
                                <input
                                    type="checkbox"
                                    :value="item.id"
                                    x-model="customMergeSelectedItems"
                                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                />
                                <span class="text-sm" x-text="item.name"></span>
                                <span
                                    class="text-xs text-gray-500"
                                    x-text="`(${item.document_count} docs)`"
                                ></span>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Selected Items Display -->
                <div
                    x-show="customMergeSelectedItems.length > 0"
                    class="border-t pt-3"
                >
                    <div class="flex flex-wrap gap-2 mb-3">
                        <template
                            x-for="itemId in customMergeSelectedItems"
                            :key="itemId"
                        >
                            <span
                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
                            >
                                <span x-text="getItemNameById(itemId)"></span>
                                <button
                                    @click="customMergeSelectedItems = customMergeSelectedItems.filter(id => id !== itemId)"
                                    class="ml-1 text-blue-600 hover:text-blue-800"
                                >
                                    &times;
                                </button>
                            </span>
                        </template>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input
                            type="text"
                            x-model="customMergeTargetName"
                            placeholder="Target name for merged item..."
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500"
                        />
                        <button
                            @click="performCustomMerge()"
                            :disabled="customMergeSelectedItems.length < 2 || !customMergeTargetName || operationInProgress"
                            :class="(customMergeSelectedItems.length < 2 || !customMergeTargetName || operationInProgress) ? 'opacity-50 cursor-not-allowed' : 'hover:bg-purple-700'"
                            class="px-4 py-2 bg-purple-600 text-white rounded-md text-sm"
                        >
                            Merge Selected
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Prefix Filter -->
        <div class="mb-4 flex items-center space-x-4">
            <input
                type="text"
                x-model="mergePrefix"
                @keyup.enter="loadMergeSuggestions()"
                placeholder="Filter by prefix (e.g., 'account')..."
                class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500"
            />
            <button
                @click="loadMergeSuggestions()"
                class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700"
            >
                Find Suggestions
            </button>
            <span
                x-show="metadataType === 'tags'"
                class="text-sm text-gray-500"
            >
                (excluding auto-match items and patterns: {{ exclude_patterns
                }})
            </span>
        </div>

        <!-- Bulk Merge Toolbar -->
        <div
            x-show="Object.keys(mergeGroups).length > 0"
            class="mb-4 bg-white shadow rounded-lg p-4"
        >
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <label class="inline-flex items-center">
                        <input
                            type="checkbox"
                            @change="selectedGroups = $event.target.checked ? Object.keys(mergeGroups) : []"
                            :checked="selectedGroups.length === Object.keys(mergeGroups).length && Object.keys(mergeGroups).length > 0"
                            class="rounded border-gray-300 text-purple-600 focus:ring-purple-500"
                        />
                        <span class="ml-2 text-sm text-gray-700"
                            >Select All Groups</span
                        >
                    </label>
                    <span class="text-sm text-gray-500">
                        <span x-text="selectedGroups.length"></span> of
                        <span x-text="Object.keys(mergeGroups).length"></span>
                        groups selected
                    </span>
                </div>
                <div class="flex items-center space-x-2">
                    <input
                        type="text"
                        x-model="bulkMergeTargetName"
                        placeholder="Target name (optional)"
                        :disabled="selectedGroups.length === 0"
                        class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-purple-500 focus:border-purple-500"
                    />
                    <button
                        @click="bulkMergeGroups()"
                        :disabled="selectedGroups.length === 0 || operationInProgress"
                        :class="(selectedGroups.length === 0 || operationInProgress) ? 'opacity-50 cursor-not-allowed' : 'hover:bg-purple-700'"
                        class="inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded-md text-sm"
                    >
                        <svg
                            x-show="operationInProgress"
                            class="animate-spin -ml-1 mr-2 h-4 w-4 text-white"
                            xmlns="http://www.w3.org/2000/svg"
                            fill="none"
                            viewBox="0 0 24 24"
                        >
                            <circle
                                class="opacity-25"
                                cx="12"
                                cy="12"
                                r="10"
                                stroke="currentColor"
                                stroke-width="4"
                            ></circle>
                            <path
                                class="opacity-75"
                                fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                            ></path>
                        </svg>
                        Merge Selected Groups
                    </button>
                </div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div
            x-show="operationInProgress"
            class="mb-4 bg-white shadow rounded-lg p-4"
        >
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-600"
                    >Processing... <span x-text="operationProgress"></span> /
                    <span x-text="operationTotal"></span
                ></span>
                <span
                    class="text-sm text-gray-600"
                    x-text="operationTotal > 0 ? Math.round((operationProgress / operationTotal) * 100) + '%' : ''"
                ></span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div
                    class="bg-purple-600 h-2 rounded-full transition-all duration-300"
                    :style="`width: ${operationTotal > 0 ? (operationProgress / operationTotal) * 100 : 0}%`"
                ></div>
            </div>
        </div>

        <!-- Merge Groups -->
        <div class="space-y-4">
            <template x-for="(group, prefix) in mergeGroups" :key="prefix">
                <div class="bg-white shadow rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <input
                                type="checkbox"
                                :value="prefix"
                                x-model="selectedGroups"
                                class="rounded border-gray-300 text-purple-600 focus:ring-purple-500"
                            />
                            <h4 class="text-lg font-medium text-gray-900">
                                "<span x-text="prefix"></span>..."
                            </h4>
                            <span
                                class="text-sm text-gray-500"
                                x-text="`${group.selected_items?.length || group[itemKey].length} of ${group[itemKey].length} items selected, ${group.total_documents} total docs`"
                            ></span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input
                                type="text"
                                :placeholder="group.suggested_name"
                                x-model="group.target_name"
                                class="px-3 py-1.5 border border-gray-300 rounded-md text-sm focus:ring-purple-500 focus:border-purple-500"
                            />
                            <button
                                @click="mergeGroup(prefix, group)"
                                :disabled="operationInProgress || (group.selected_items?.length || 0) < 2"
                                :class="(operationInProgress || (group.selected_items?.length || 0) < 2) ? 'opacity-50 cursor-not-allowed' : 'hover:bg-purple-700'"
                                class="px-3 py-1.5 bg-purple-600 text-white rounded-md text-sm"
                            >
                                Merge
                            </button>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <template x-for="item in group[itemKey]" :key="item.id">
                            <span
                                @click="toggleItemInGroup(group, item.id)"
                                class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium cursor-pointer transition-all"
                                :class="group.selected_items?.includes(item.id) ? '' : 'opacity-40 line-through'"
                                :style="metadataType === 'tags'
                                    ? `background-color: ${item.color}20; color: ${item.color}; border: 1px solid ${item.color}`
                                    : 'background-color: #e5e7eb; color: #374151; border: 1px solid #d1d5db'"
                            >
                                <span x-text="item.name"></span>
                                <span
                                    class="ml-1 opacity-75"
                                    x-text="`(${item.document_count})`"
                                ></span>
                            </span>
                        </template>
                    </div>
                </div>
            </template>
        </div>

        <!-- Empty State -->
        <div
            x-show="Object.keys(mergeGroups).length === 0"
            class="text-center py-8 text-gray-500"
        >
            No merge suggestions found. Try adjusting the prefix filter.
        </div>
    </div>

    <!-- Edit Modal -->
    <div
        x-show="showEditModal"
        x-cloak
        class="fixed inset-0 z-50 overflow-y-auto"
        aria-labelledby="modal-title"
        role="dialog"
        aria-modal="true"
    >
        <div
            class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"
        >
            <div
                class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
                @click="showEditModal = false"
            ></div>
            <span
                class="hidden sm:inline-block sm:align-middle sm:h-screen"
                aria-hidden="true"
                >&#8203;</span
            >
            <div
                class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"
            >
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3
                        class="text-lg leading-6 font-medium text-gray-900 mb-4"
                        x-text="editModalTitle"
                    ></h3>
                    <div class="space-y-4">
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700"
                                >Name</label
                            >
                            <input
                                type="text"
                                x-model="editForm.name"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                            />
                        </div>
                        <div x-show="metadataType === 'tags'">
                            <label
                                class="block text-sm font-medium text-gray-700"
                                >Color</label
                            >
                            <div class="mt-1 flex items-center space-x-2">
                                <input
                                    type="color"
                                    x-model="editForm.color"
                                    class="h-10 w-20 rounded border border-gray-300"
                                />
                                <span
                                    class="text-sm text-gray-500"
                                    x-text="editForm.color"
                                ></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div
                    class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"
                >
                    <button
                        type="button"
                        @click="saveEdit()"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm"
                    >
                        Save
                    </button>
                    <button
                        type="button"
                        @click="showEditModal = false"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div
        x-show="showConfirm"
        x-cloak
        class="fixed inset-0 z-50 overflow-y-auto"
        aria-labelledby="modal-title"
        role="dialog"
        aria-modal="true"
    >
        <div
            class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"
        >
            <div
                class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
            ></div>
            <span
                class="hidden sm:inline-block sm:align-middle sm:h-screen"
                aria-hidden="true"
                >&#8203;</span
            >
            <div
                class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"
            >
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div
                            class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10"
                        >
                            <svg
                                class="h-6 w-6 text-red-600"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                                />
                            </svg>
                        </div>
                        <div
                            class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left"
                        >
                            <h3
                                class="text-lg leading-6 font-medium text-gray-900"
                                x-text="confirmTitle"
                            ></h3>
                            <div class="mt-2">
                                <p
                                    class="text-sm text-gray-500 whitespace-pre-wrap"
                                    x-text="confirmMessage"
                                ></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div
                    class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"
                >
                    <button
                        type="button"
                        @click="confirmAction(); showConfirm = false"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm"
                    >
                        Confirm
                    </button>
                    <button
                        type="button"
                        @click="showConfirm = false"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function metadataManager() {
        return {
            // Core state
            metadataType: "tags",
            activeTab: "all",
            loading: false,
            operationInProgress: false,
            operationProgress: 0,
            operationTotal: 0,
            customFields: [],

            // Data arrays
            items: [],
            cleanupItems: [],
            mergeGroups: {},
            selectedItems: [],
            selectedGroups: [],

            // Filtering/sorting
            filter: "",
            sortBy: "name",
            maxDocs: "0",
            mergePrefix: "",

            // Custom merge state
            customMergeSearch: "",
            customMergeSearchResults: [],
            customMergeSelectedItems: [],
            customMergeItemNames: {},
            customMergeTargetName: "",
            bulkMergeTargetName: "",

            // Pagination state (All tab)
            currentPage: 1,
            pageSize: 50,
            totalPages: 1,
            totalItems: 0,

            // Pagination state (Cleanup tab)
            cleanupCurrentPage: 1,
            cleanupPageSize: 50,
            cleanupTotalPages: 1,
            totalCleanupItems: 0,

            // Modals
            showConfirm: false,
            confirmTitle: "",
            confirmMessage: "",
            confirmAction: () => {},

            showEditModal: false,
            editModalTitle: "",
            editId: null,
            editForm: {
                name: "",
                color: "",
            },

            // Computed
            get isCustomField() {
                return this.metadataType.startsWith("custom_field_");
            },

            get apiEndpoint() {
                if (this.metadataType === "tags") return "/api/tags";
                if (this.metadataType === "correspondents")
                    return "/api/correspondents";
                if (this.metadataType === "document_types")
                    return "/api/document_types";
                return null;
            },

            get itemKey() {
                if (this.metadataType === "tags") return "tags";
                if (this.metadataType === "correspondents")
                    return "correspondents";
                if (this.metadataType === "document_types")
                    return "document_types";
                return "items";
            },

            get itemIdKey() {
                if (this.metadataType === "correspondents")
                    return "correspondent_ids";
                if (this.metadataType === "document_types")
                    return "document_type_ids";
                return "tag_ids";
            },

            get filteredItems() {
                let result = [...this.items];

                // Sorting only - filtering is done server-side
                if (this.sortBy === "name") {
                    result.sort((a, b) => a.name.localeCompare(b.name));
                } else if (this.sortBy === "count") {
                    result.sort((a, b) => a.document_count - b.document_count);
                } else if (this.sortBy === "count-desc") {
                    result.sort((a, b) => b.document_count - a.document_count);
                }

                return result;
            },

            // Methods
            async init() {
                await this.loadCustomFields();
                await this.loadData();
            },

            async loadCustomFields() {
                try {
                    const resp = await fetch("/api/custom_fields");
                    const data = await resp.json();
                    this.customFields = data.custom_fields || [];
                } catch (e) {
                    console.error("Failed to load custom fields:", e);
                    this.customFields = [];
                }
            },

            onMetadataTypeChange() {
                // Reset state when switching metadata types
                this.activeTab = "all";
                this.items = [];
                this.cleanupItems = [];
                this.mergeGroups = {};
                this.selectedItems = [];
                this.selectedGroups = [];
                this.currentPage = 1;
                this.cleanupCurrentPage = 1;
                this.totalItems = 0;
                this.totalCleanupItems = 0;
                this.filter = "";
                this.customMergeSearch = "";
                this.customMergeSearchResults = [];
                this.customMergeSelectedItems = [];
                this.customMergeItemNames = {};
                this.customMergeTargetName = "";
                this.loadData();
            },

            async loadData(page = null) {
                if (this.isCustomField || !this.apiEndpoint) return;

                this.loading = true;
                if (page !== null) {
                    this.currentPage = page;
                }
                try {
                    let url = `${this.apiEndpoint}?page=${this.currentPage}&page_size=${this.pageSize}`;
                    if (this.filter) {
                        url += `&filter=${encodeURIComponent(this.filter)}`;
                    }
                    const resp = await fetch(url);
                    const data = await resp.json();
                    this.items = data[this.itemKey];
                    this.totalPages = data.total_pages;
                    this.totalItems = data.total;
                } catch (e) {
                    showToast("Failed to load data: " + e.message, "error");
                }
                this.loading = false;
            },

            async loadCleanup(page = null) {
                if (this.isCustomField || !this.apiEndpoint) return;

                this.loading = true;
                this.selectedItems = [];
                if (page !== null) {
                    this.cleanupCurrentPage = page;
                }
                try {
                    const resp = await fetch(
                        `${this.apiEndpoint}/low-usage?max_docs=${this.maxDocs}&page=${this.cleanupCurrentPage}&page_size=${this.cleanupPageSize}`,
                    );
                    const data = await resp.json();
                    this.cleanupItems = data[this.itemKey];
                    this.cleanupTotalPages = data.total_pages;
                    this.totalCleanupItems = data.total;
                } catch (e) {
                    showToast(
                        "Failed to load cleanup items: " + e.message,
                        "error",
                    );
                }
                this.loading = false;
            },

            async loadMergeSuggestions() {
                if (this.isCustomField || !this.apiEndpoint) return;

                this.loading = true;
                this.selectedGroups = [];
                try {
                    let url = `${this.apiEndpoint}/merge-suggestions`;
                    if (this.mergePrefix) {
                        url += `?prefix=${encodeURIComponent(this.mergePrefix)}`;
                    }
                    const resp = await fetch(url);
                    const data = await resp.json();
                    // Initialize selected_items for each group
                    const groups = data.groups;
                    for (const prefix in groups) {
                        const group = groups[prefix];
                        group.selected_items = group[this.itemKey].map(
                            (item) => item.id,
                        );
                    }
                    this.mergeGroups = groups;
                } catch (e) {
                    showToast(
                        "Failed to load suggestions: " + e.message,
                        "error",
                    );
                }
                this.loading = false;
            },

            editItem(item) {
                this.editId = item.id;
                this.editModalTitle = `Edit ${this.metadataType === "tags" ? "Tag" : this.metadataType === "correspondents" ? "Correspondent" : "Document Type"}`;
                this.editForm.name = item.name;
                this.editForm.color = item.color || "#a6cee3";
                this.showEditModal = true;
            },

            async saveEdit() {
                if (!this.editForm.name.trim()) {
                    showToast("Name cannot be empty", "error");
                    return;
                }

                try {
                    const body =
                        this.metadataType === "tags"
                            ? {
                                  name: this.editForm.name,
                                  color: this.editForm.color,
                              }
                            : { name: this.editForm.name };

                    const resp = await fetch(
                        `${this.apiEndpoint}/${this.editId}`,
                        {
                            method: "PATCH",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(body),
                        },
                    );

                    if (!resp.ok) {
                        const err = await resp.json();
                        throw new Error(err.detail || "Update failed");
                    }

                    showToast("Updated successfully", "success");
                    this.showEditModal = false;
                    this.loadData();
                } catch (e) {
                    showToast("Failed to update: " + e.message, "error");
                }
            },

            deleteIndividualItem(item) {
                this.confirmTitle = `Delete "${item.name}"?`;
                this.confirmMessage = `This will permanently delete this item. Documents will not be affected.`;
                this.confirmAction = async () => {
                    try {
                        const resp = await fetch(`${this.apiEndpoint}/delete`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                [this.itemIdKey]: [item.id],
                            }),
                        });

                        if (!resp.ok) {
                            const err = await resp.json();
                            throw new Error(err.detail || "Delete failed");
                        }

                        showToast("Deleted successfully", "success");
                        this.loadData();
                    } catch (e) {
                        showToast("Failed to delete: " + e.message, "error");
                    }
                };
                this.showConfirm = true;
            },

            async deleteSelectedItems() {
                if (this.selectedItems.length === 0) return;

                this.confirmTitle = `Delete ${this.selectedItems.length} items?`;
                this.confirmMessage = `This will permanently delete these items. Documents will not be affected.`;
                this.confirmAction = async () => {
                    this.operationInProgress = true;
                    this.operationProgress = 0;
                    this.operationTotal = this.selectedItems.length;

                    const batchSize = 10;
                    const batches = [];
                    for (
                        let i = 0;
                        i < this.selectedItems.length;
                        i += batchSize
                    ) {
                        batches.push(
                            this.selectedItems.slice(i, i + batchSize),
                        );
                    }

                    try {
                        for (const batch of batches) {
                            const resp = await fetch(
                                `${this.apiEndpoint}/delete`,
                                {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify({
                                        [this.itemIdKey]: batch,
                                    }),
                                },
                            );

                            if (!resp.ok) {
                                const err = await resp.json();
                                throw new Error(err.detail || "Delete failed");
                            }

                            this.operationProgress += batch.length;
                        }

                        showToast(
                            `Deleted ${this.selectedItems.length} items`,
                            "success",
                        );
                        this.selectedItems = [];
                        this.loadCleanup();
                    } catch (e) {
                        showToast("Failed to delete: " + e.message, "error");
                    }

                    this.operationInProgress = false;
                };
                this.showConfirm = true;
            },

            async searchItemsForCustomMerge() {
                if (this.customMergeSearch.length < 2) {
                    this.customMergeSearchResults = [];
                    return;
                }

                try {
                    const url = `${this.apiEndpoint}?page=1&page_size=20&filter=${encodeURIComponent(this.customMergeSearch)}`;
                    const resp = await fetch(url);
                    const data = await resp.json();
                    const results = data[this.itemKey].filter(
                        (item) =>
                            !this.customMergeSelectedItems.includes(item.id),
                    );
                    // Cache item names for display
                    results.forEach((item) => {
                        this.customMergeItemNames[item.id] = item.name;
                    });
                    this.customMergeSearchResults = results;
                } catch (e) {
                    console.error("Failed to search items:", e);
                    this.customMergeSearchResults = [];
                }
            },

            getItemNameById(id) {
                // Check cache first (populated from search results)
                if (this.customMergeItemNames[id]) {
                    return this.customMergeItemNames[id];
                }
                // Fallback to current page items
                const item = this.items.find((i) => i.id === id);
                return item ? item.name : `ID: ${id}`;
            },

            performCustomMerge() {
                if (
                    this.customMergeSelectedItems.length < 2 ||
                    !this.customMergeTargetName
                ) {
                    showToast(
                        "Select at least 2 items and provide a target name",
                        "error",
                    );
                    return;
                }

                const itemCount = this.customMergeSelectedItems.length;
                const targetName = this.customMergeTargetName;
                const itemNames = this.customMergeSelectedItems
                    .map((id) => this.getItemNameById(id))
                    .join(", ");

                this.confirmTitle = `Merge ${itemCount} items?`;
                this.confirmMessage = `This will merge the following into "${targetName}":\n\n${itemNames}\n\nThis action cannot be undone.`;
                this.confirmAction = async () => {
                    this.operationInProgress = true;
                    try {
                        const resp = await fetch(`${this.apiEndpoint}/merge`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                source_ids: this.customMergeSelectedItems,
                                target_name: this.customMergeTargetName,
                            }),
                        });

                        if (!resp.ok) {
                            const err = await resp.json();
                            throw new Error(err.detail || "Merge failed");
                        }

                        const result = await resp.json();
                        showToast(result.message, "success");

                        this.customMergeSelectedItems = [];
                        this.customMergeTargetName = "";
                        this.customMergeSearch = "";
                        this.customMergeSearchResults = [];
                        this.loadData();
                        this.loadMergeSuggestions();
                    } catch (e) {
                        showToast("Failed to merge: " + e.message, "error");
                    }
                    this.operationInProgress = false;
                };
                this.showConfirm = true;
            },

            toggleItemInGroup(group, itemId) {
                if (!group.selected_items) {
                    group.selected_items = group[this.itemKey].map((i) => i.id);
                }
                const index = group.selected_items.indexOf(itemId);
                if (index > -1) {
                    group.selected_items.splice(index, 1);
                } else {
                    group.selected_items.push(itemId);
                }
            },

            mergeGroup(prefix, group) {
                const targetName =
                    group.target_name || group.suggested_name || prefix;
                const sourceIds =
                    group.selected_items ||
                    group[this.itemKey].map((item) => item.id);

                if (sourceIds.length < 2) {
                    showToast("Select at least 2 items to merge", "error");
                    return;
                }

                const itemNames = group[this.itemKey]
                    .filter((item) => sourceIds.includes(item.id))
                    .map((item) => item.name)
                    .join(", ");

                this.confirmTitle = `Merge ${sourceIds.length} items?`;
                this.confirmMessage = `This will merge the following into "${targetName}":\n\n${itemNames}\n\nThis action cannot be undone.`;
                this.confirmAction = async () => {
                    this.operationInProgress = true;
                    try {
                        const resp = await fetch(`${this.apiEndpoint}/merge`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                source_ids: sourceIds,
                                target_name: targetName,
                            }),
                        });

                        if (!resp.ok) {
                            const err = await resp.json();
                            throw new Error(err.detail || "Merge failed");
                        }

                        const result = await resp.json();
                        showToast(result.message, "success");

                        delete this.mergeGroups[prefix];
                        this.loadData();
                    } catch (e) {
                        showToast("Failed to merge: " + e.message, "error");
                    }
                    this.operationInProgress = false;
                };
                this.showConfirm = true;
            },

            bulkMergeGroups() {
                if (this.selectedGroups.length === 0) return;

                // Collect all items to be merged with their target names
                const mergeDetails = [];
                let totalItems = 0;
                for (const prefix of this.selectedGroups) {
                    const group = this.mergeGroups[prefix];
                    if (group) {
                        const sourceIds =
                            group.selected_items ||
                            group[this.itemKey].map((i) => i.id);
                        const targetName =
                            this.bulkMergeTargetName ||
                            group.target_name ||
                            group.suggested_name ||
                            prefix;
                        const itemNames = group[this.itemKey]
                            .filter((item) => sourceIds.includes(item.id))
                            .map((item) => item.name);
                        totalItems += itemNames.length;
                        mergeDetails.push(
                            `"${targetName}": ${itemNames.join(", ")}`,
                        );
                    }
                }

                this.confirmTitle = `Merge ${this.selectedGroups.length} groups (${totalItems} items)?`;
                this.confirmMessage = `This will perform the following merges:\n\n${mergeDetails.join("\n\n")}\n\nThis action cannot be undone.`;
                this.confirmAction = async () => {
                    this.operationInProgress = true;
                    this.operationProgress = 0;
                    this.operationTotal = this.selectedGroups.length;

                    try {
                        for (const prefix of this.selectedGroups) {
                            const group = this.mergeGroups[prefix];
                            if (!group) {
                                console.warn(
                                    `Skipping group "${prefix}" - not found`,
                                );
                                this.operationProgress++;
                                continue;
                            }
                            const targetName =
                                this.bulkMergeTargetName ||
                                group.target_name ||
                                group.suggested_name ||
                                prefix;
                            const sourceIds =
                                group.selected_items ||
                                group[this.itemKey].map((item) => item.id);

                            if (sourceIds.length < 2) {
                                console.warn(
                                    `Skipping group "${prefix}" - less than 2 items selected`,
                                );
                                this.operationProgress++;
                                continue;
                            }

                            const resp = await fetch(
                                `${this.apiEndpoint}/merge`,
                                {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify({
                                        source_ids: sourceIds,
                                        target_name: targetName,
                                    }),
                                },
                            );

                            if (!resp.ok) {
                                const err = await resp.json();
                                throw new Error(
                                    `Failed to merge "${prefix}": ${err.detail || "Unknown error"}`,
                                );
                            }

                            delete this.mergeGroups[prefix];
                            this.operationProgress++;
                        }

                        showToast(
                            `Merged ${this.selectedGroups.length} groups`,
                            "success",
                        );
                        this.selectedGroups = [];
                        this.bulkMergeTargetName = "";
                        this.loadData();
                    } catch (e) {
                        showToast("Merge error: " + e.message, "error");
                    }
                    this.operationInProgress = false;
                };
                this.showConfirm = true;
            },
        };
    }
</script>
{% endblock %}
